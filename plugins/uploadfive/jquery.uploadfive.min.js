(function(d,g,b){var h=g.document,i=g.navigator,j=g.location;var c={NOT_ALLOW_SELECT:"不合法的文件将不被添加到队列中！",NOT_ALLOW_UPLOAD:"文件 ${fileName} 类型不合法，不允许上传！",REPLACE_FIlE_IN_QUEUE:"文件 ${fileName} 已存在队列中，是否继续添加？",};var k={addEvent:function(m,o,n){m=m||h;if(h.addEventListener){m.addEventListener(o,n,false)}else{m.attachEvent("on"+o,n)}},removeEvent:function(m,o,n){m=m||h;if(h.removeEventListener){m.removeEventListener(o,n,false)}else{m.detachEvent("on"+o,n)}}};var a={init:function(m){return this.each(function(){var s=this,u=d(this),q=u.parent();var t=u.clone();var v={id:u.attr("id"),};var o=d.extend({auto:true,uploader:"",method:"POST",dataType:false,fileObjName:"Filedata",multi:false,fileTypeExts:"*.*",queueID:false,buttonText:"选择文件",buttonClass:"uploadfive-button",buttonCursor:"pointer",removeCancelled:true,removeCompleted:true,removeTimeout:3,progressData:"percentage",itemTemplate:false,},m,v);var n={file_post_name:o.fileObjName,file_allow_ext:o.fileTypeExts,request_method:o.method,request_url:o.uploader,settings:o,method_upload_handler:a.upload,method_cancel_handler:a.cancel,file_queued_handler:l.onSelect,object_init_handler:o.onInit||b,upload_cancel_handler:l.onCancel,upload_error_handler:l.onUploadError,upload_progress_handler:l.onUploadProgress,upload_start_handler:l.onUploadStart,upload_success_handler:l.onUploadSuccess,};g["uploadfive_"+o.id]=d.extend({},n);var p=g["uploadfive_"+o.id];var x=f.initButtonText.call(p);u=d("#"+o.id);u.data("uploadfive",p);if(!o.queueID){var r=d("<div />",{"id":o.id+"-queue","class":"uploadfive-queue"});u.after(r);p.settings.queueID=o.id+"-queue";p.settings.defaultQueue=true}p.queueData=f.getDefaultQueueData();p.original=t;p.queue=r||d("#"+o.queueID);d("#"+o.id+" #"+x).on("change",function(){var C=this.files,y=C.length;var B=false;for(var A=0;A<y;A++){var z=C[A];if(e.allowUpload(z,o.fileTypeExts)){if(e.inQueue(z,p.queueData.filesQueued)){if(!confirm(c.REPLACE_FIlE_IN_QUEUE.replace("${fileName}",z.name))){continue}}if(!B){p.queueData.filesSelected++;B=true}p.file_queued_handler.call(p,z)}else{alert(c.NOT_ALLOW_UPLOAD.replace("${fileName}",z.name))}}d(this).val("");if(o.auto&&p.queueData.uploadQueue.length<=0){p.method_upload_handler.call(u)}});var w=p.object_init_handler;if(w&&typeof w==="function"){w.call(u,p)}})},cancel:function(m,n){var o=arguments;return this.each(function(){var w=d(this),q=w.data("uploadfive"),p=q.settings;var s=q.queue;var t=o[0];if(t){if(t=="*"){var v=q.queueData.filesQueued,x=q.queueData.filesLength;for(var r in v){if(v.hasOwnProperty(r)){f.cancelUpload.call(q,r,function(){s.find("#"+r+" .cancel").remove();if(p.removeCancelled){s.find("#"+r).fadeOut(p.removeTimeout*1000,function(){d(this).remove()})}})}}f.clearQueue.call(q,function(){if(e.isFunction(p.onClearQueue)){p.onClearQueue.call(w,x)}})}else{f.cancelUpload.call(q,t,function(){s.find("#"+t+" .cancel").remove();if(p.removeCancelled){s.find("#"+t).fadeOut(p.removeTimeout*1000,function(){d(this).remove()})}})}}else{var u=s.find(".uploadfive-queue-item").eq(0).attr("id");f.cancelUpload.call(q,u,function(){s.find("#"+u+" .cancel").remove();if(p.removeCancelled){s.find("#"+u).fadeOut(p.removeTimeout*1000,function(){d(this).remove()})}})}})},upload:function(m){var n=arguments;return this.each(function(){var s=d(this),p=s.data("uploadfive"),q=p.settings,o=p.queueData;var r=p.queue;if(o.uploadQueue.length>0){return false}f.loadUploadQueue.apply(p,n);if(o.uploadQueue.length>0){f.startUpload.call(p,o.uploadQueue.shift())}})}};var l={onCancel:function(o){var n=this,p=this.settings,m=this.queueData,q=this.queue.find("#"+o.id);if(e.isFunction(p.onCancel)){p.onCancel.call(q,o)}},onSelect:function(o){var p=this.settings,u=this.queueData,v=null;var t="FDUpload_"+(u.filesSelected-1)+"_"+u.filesLength;u.files[t]=o;var s=e.getFileInfos(o);var w=d.extend({},o,{id:t,index:u.filesLength,filestatus:-1,type:s.type});v=this.queue.find("#"+w.id);u.filesLength++;u.queueSize+=o.size;var r=o.name;var q={"fileID":t,"instanceID":p.id,"fileFullName":r,"fileName":r.length>20?(r.substring(0,20)+"..."):r,"fileSize":s.size,"fileType":s.type};if(!p.itemTemplate){p.itemTemplate='<div id="${fileID}" class="uploadfive-queue-item">                    <div class="cancel">                        <a title="取消" href="javascript:$(\'#${instanceID}\').uploadfive(\'cancel\', \'${fileID}\')">X</a>                    </div>                    <span title="${fileFullName}" class="fileName">${fileName} (${fileSize})</span><span class="data"></span>                    <div class="uploadfive-progress">                        <div class="uploadfive-progress-bar"><!--Progress Bar--></div>                    </div>                </div>'}var x=p.itemTemplate;for(var m in q){x=x.replace(new RegExp("\\$\\{"+m+"\\}","g"),q[m])}this.queue.append(x);u.filesQueued[t]=w;if(e.isFunction(p.onSelect)){p.onSelect.call(v,w)}},onUploadError:function(p){var n=this,q=this.settings,m=this.queueData,r=this.queue.find("#"+p.id);f.setFileStatus(p,0);m.uploadsErrored++;var o=this.queue.find("#"+p.id);o.find(".data").html(" - Errored");o.find(".uploadfive-progress-bar").css("width","1px");o.find(".cancel").remove();if(q.removeCompleted){o.fadeOut(q.removeTimeout*1000,function(){d(this).remove()})}if(e.isFunction(q.onUploadError)){q.onUploadError(p)}f.uploadComplete.call(n,p)},onUploadProgress:function(o,y,s){var q=this,p=this.settings,v=this.queueData,w=this.queue.find("#"+o.id);var m=(new Date()).getTime(),t=m-this.timer;if(t>500){this.timer=m}var r=y-this.bytesLoaded;v.queueBytesUploaded+=y;this.bytesLoaded=y;var B=Math.round(y/s*100);var A="KB/s";var n=(r*1024)/(t*1000);n=Math.floor(n*10)/10;if(v.averageSpeed>0){v.averageSpeed=Math.floor((v.averageSpeed+n)/2)}else{v.averageSpeed=n}if(n>1000){var u=Math.floor(n/1000);v.averageSpeed=u;A="MB/s"}var x={"percentage":B+"%","speed":v.averageSpeed+A};var z=this.queue.find("#"+o.id);z.find(".data").html(" - "+(x[p.processData]||(B+"%")));z.find(".uploadfive-progress-bar").css("width",(B+"%"));if(e.isFunction(p.onUploadProgress)){p.onUploadProgress.call(w,o,y,s,v.queueBytesUploaded,v.queueSize)}},onUploadStart:function(n){var o=this,q=this.settings,m=this.queueData,r=this.queue.find("#"+n);this.timer=(new Date()).getTime();this.bytesLoaded=0;var p=m.filesQueued[n];f.setFileStatus(p,2);if(e.isFunction(q.onUploadStart)){q.onUploadStart.call(r,p)}},onUploadSuccess:function(p,r){var n=this,q=this.settings,m=this.queueData,s=this.queue.find("#"+p.id);f.setFileStatus(p,1);m.uploadsSuccessful++;m.queueBytesUploaded+=p.size;var o=this.queue.find("#"+p.id);o.find(".data").html(" - Completed");o.find(".cancel").remove();if(q.removeCompleted){o.fadeOut(q.removeTimeout*1000,function(){d(this).remove()})}if(e.isFunction(q.onUploadSuccess)){q.onUploadSuccess.call(s,p,r)}f.uploadComplete.call(n,p)}};var f={initButtonText:function(){var p=this.settings;var n=p.fileTypeExts=="*.*"?"":(' accept="'+p.fileTypeExts.replace(/\*\./ig,".")+'"');var o="uploadfive_"+p.id;var m='<div class="'+p.buttonClass+'" style="cursor:'+p.buttonCursor+';" id="'+p.id+'">'+"<span>"+p.buttonText+"</span>"+'<input type="file"'+n+' id="'+o+'" name="'+o+'" '+(p.multi?'multiple="multiple"':"")+" />"+"</div>";d("#"+p.id).replaceWith(m);return o},startUpload:function(n){var o=this,r=this.settings,m=o.queueData;o.upload_start_handler.call(this,n);var q=m.files[n],s=m.filesQueued[n];var p=new FormData();p.append(r.fileObjName,q);d.ajax({url:o.request_url,type:o.request_method,data:p,contentType:false,processData:false,dataType:r.dataType,xhr:function(){var t=d.ajaxSettings.xhr();m.xhrs[n]=t;k.addEvent(t.upload,"progress",function(x){var v=x||g.event;var u=v.loaded||0,w=v.total||s.size;o.upload_progress_handler.call(o,s,u,w)});k.addEvent(t,"abort",function(v){var u=v||g.event;o.upload_cancel_handler.call(o,s)});return t},success:function(t){o.upload_success_handler.call(o,s,t)},error:function(){o.upload_error_handler.call(o,s)}})},cancelUpload:function(r,t){var o=this,n=this.settings,s=this.queueData,m=s.filesQueued[r];if(e.inArray(f.getFileStatus(m),[-1,2])>-1){o.queue.find("#"+r+" .data").html(" - Cancelled");o.queue.find(".uploadfive-progress-bar").css("width","1px");f.setFileStatus(m,3);s.uploadsCancelled++;var q=e.inArray(r,s.uploadQueue);if(q>-1){var p=s.uploadQueue;s.uploadQueue=[].concat(p.slice(0,q),p.slice((q+1),p.length))}var u=s.xhrs[r];if(u){u.abort()}else{o.upload_cancel_handler.call(this,m)}}if(e.isFunction(t)){t()}},clearQueue:function(o){var m=this,n=this.settings;m.queueData=f.getDefaultQueueData();m.queue.find(".uploadfive-queue-item").fadeOut(n.removeTimeout*1000,function(){d(this).remove()});m.timer=0;delete m.timer;m.bytesLoaded=0;delete m.bytesLoaded;if(e.isFunction(o)){o()}},getDefaultQueueData:function(){var m={files:{},filesQueued:{},filesSelected:0,filesLength:0,averageSpeed:0,queueBytesUploaded:0,queueSize:0,uploadSize:0,uploadQueue:[],uploadsSuccessful:0,uploadsErrored:0,uploadsCancelled:0,xhrs:{},};return m},loadUploadQueue:function(r){var n=this,t=n.queueData;var u=[],s=0;r=r||"*";var q=t.filesQueued;var m=null;if(r&&typeof r==="string"){if(r=="*"){for(var o in q){m=q[o];if(m.filestatus==-1){s+=m.size;u.push(m.id)}}}else{m=q[r];if(m&&m.filestatus==-1){s+=m.size;u.push(r)}}}else{var p=r;for(var o=0;o<p;o++){m=q[r[o]];if(m&&m.filestatus==-1){s+=m.size;u.push(m.id)}}}t.uploadSize=s;t.uploadQueue=u;return u},getFileStatus:function(m){return m.filestatus},setFileStatus:function(n,m){n.filestatus=m;return n.filestatus},uploadComplete:function(o){var n=this,p=this.settings,m=this.queueData,q=this.queue.find("#"+o.id);if(e.isFunction(p.onUploadComplete)){p.onUploadComplete.call(q,o)}if(m.uploadQueue.length>0){f.startUpload.call(n,m.uploadQueue.shift())}if(m.filesLength==(m.uploadsSuccessful+m.uploadsErrored+m.uploadsCancelled)){if(e.isFunction(p.onQueueComplete)){p.onQueueComplete.call(q,{"uploadsSuccessful":m.uploadsSuccessful,"uploadsErrored":m.uploadsErrored,"uploadsCancelled":m.uploadsCancelled})}if(p.removeCompleted){f.clearQueue.call(this)}else{m=d.extend({},m,{filesLength:0,averageSpeed:0,queueBytesUploaded:0,queueSize:0,uploadSize:0,uploadQueue:[],uploadsSuccessful:0,uploadsErrored:0,uploadsCancelled:0,})}}}};var e={allowUpload:function(p,m){var o=m.split(",");for(var n=o.length-1;n>-1;n--){o[n]="("+(o[n].replace(".","\\.").replace("*",".*"))+"$)"}o=o.join("|");return(new RegExp(o,"ig")).test(p.name)},cleckQueueExts:function(p,n){var m=p.length;for(var o=p.length;o>-1;o--){if(!this.allowUpload(p,n)){return true}}return false},computeFileSize:function(m,n){n=n||2;if(m>1024*1024*1024*1024){m=m/(1024*1024*1024*1024);m=(""+m).indexOf(".")>-1?m.toFixed(n):m;return m+"TB"}else{if(m>1024*1024*1024){m=m/(1024*1024*1024);m=(""+m).indexOf(".")>-1?m.toFixed(n):m;return m+"GB"}else{if(m>1024*1024){m=m/(1024*1024);m=(""+m).indexOf(".")>-1?m.toFixed(n):m;return m+"MB"}else{if(m>1024){return(Math.round(m/1024))+"KB"}else{return Math.round(m)+"Byte"}}}}},getFileInfos:function(m){var n=m.name.lastIndexOf(".");if(n>-1){return{name:m.name.substring(0,n)||"未命名文件",type:m.name.substring(n)||"未知格式",size:this.computeFileSize(m.size)}}return{}},inArray:function(o,m){if(d.inArray){return d.inArray(o,m)}else{for(var n=m.length-1;n>-1;n--){if(m[n]==o){return n}}return -1}},isFunction:function(m){if(m&&typeof m==="function"){return true}return false},inQueue:function(n,o){for(var m in o){if(o.hasOwnProperty(m)){if(n.name==o[m].name&&o[m].filestatus==-1&&n.size==o[m].size){return o[m].id}}}return false}};d.fn.uploadfive=function(m){if(a[m]){return a[m].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof m==="object"||!m){return a.init.apply(this,arguments)}else{d.error("方法 "+m+" 在$.uploadfive中未定义！")}}}}(jQuery,window,undefined));